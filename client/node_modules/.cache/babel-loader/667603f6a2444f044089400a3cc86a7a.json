{"ast":null,"code":"import { PerspectiveCamera, Scene, Vector3, WebGLRenderer, Clock, Raycaster, UnsignedByteType, LinearToneMapping } from \"three\";\nimport Stats from 'three/examples/jsm/libs/stats.module';\nimport { FirstPersonControls } from 'three/examples/jsm/controls/FirstPersonControls';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';\nimport { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader';\nimport { VRButton } from 'three/examples/jsm/webxr/VRButton.js';\nimport { ambientLight } from './Tlights';\nexport class TEngine {\n  constructor(dom) {\n    this.dom = void 0;\n    this.renderer = void 0;\n    this.mixer = void 0;\n    this.pmremGenerator = void 0;\n    this.scene = void 0;\n    this.raycaster = void 0;\n    this.camera = void 0;\n    this.clock = void 0;\n    this.controls = void 0;\n    this.model = void 0;\n    this.heart = void 0;\n    this.newEnterIndex = 0;\n    this.stats = void 0;\n    this.dom = dom;\n    this.renderer = new WebGLRenderer({\n      antialias: true\n    });\n    this.renderer.xr.enabled = true;\n    this.clock = new Clock();\n    this.renderer.shadowMap.enabled = true;\n    this.renderer.toneMapping = LinearToneMapping;\n    this.scene = new Scene();\n    this.scene.add(ambientLight); //const pmremGenerator = new PMREMGenerator(this.renderer); // 使用hdr作为背景色\n    //pmremGenerator.compileEquirectangularShader();\n    //this.pmremGenerator = pmremGenerator;\n\n    const scene = this.scene;\n    new RGBELoader().setDataType(UnsignedByteType).load('/texture/autumn_forest_04_1k.hdr', function (texture) {\n      // const envMap = pmremGenerator.fromEquirectangular(texture).texture;\n      // envMap.isPmremTexture = true;\n      // pmremGenerator.dispose();\n      console.log('here'); // scene.environment = envMap; // 给场景添加环境光效果\n      // scene.background = envMap; // 给场景添加背景图\n    }, () => {}, e => {\n      console.log('error in load env_texture', e);\n    });\n    this.camera = new PerspectiveCamera(60, dom.offsetWidth / dom.offsetHeight, 1, 1000);\n    this.renderer.setSize(dom.offsetWidth, dom.offsetHeight, true); // 初始性能监视器\n\n    const stats = Stats();\n    const statsDom = stats.domElement;\n    this.stats = stats;\n    statsDom.style.position = 'fixed';\n    statsDom.style.top = '0';\n    statsDom.style.right = '5px';\n    statsDom.style.left = 'unset';\n    let controls;\n    controls = new FirstPersonControls(this.camera, this.dom);\n    controls.lookSpeed = 0.2; //鼠标移动查看的速度\n\n    controls.movementSpeed = 20; //相机移动速度\n    // controls.noFly = true;\n\n    controls.constrainVertical = true; //约束垂直\n\n    controls.verticalMin = Math.PI / 2;\n    controls.verticalMax = Math.PI / 2 + 0.0000001;\n    this.controls = controls;\n    this.controls.object.position.set(0, 28, 20);\n    this.controls.object.lookAt(new Vector3(0, 0, 0));\n    this.camera.up = new Vector3(0, 1, 0);\n    const raycaster = new Raycaster();\n    this.raycaster = raycaster;\n\n    const onWindowResize = () => {\n      this.camera.aspect = window.innerWidth / window.innerHeight;\n      this.camera.updateProjectionMatrix();\n      this.renderer.setSize(dom.offsetWidth, dom.offsetHeight, true);\n    };\n\n    window.addEventListener('resize', onWindowResize); //     const renderFun = () => {\n    // //@ts-ignore\n    //       this.controls.update(this.clock.getDelta())\n    //       this.renderer.render(this.scene, this.camera)\n    //       stats.update()\n    //       TWEEN.update();\n    //      updateUserVideoRotation()\n    //       requestAnimationFrame(renderFun)\n    //     }\n    //this.renderid=requestAnimationFrame(this.renderFun);\n\n    this.renderer.setAnimationLoop(() => {\n      this.controls.update(this.clock.getDelta());\n      this.renderer.render(this.scene, this.camera);\n      stats.update();\n    });\n    dom.appendChild(this.renderer.domElement);\n    dom.appendChild(statsDom);\n    dom.appendChild(VRButton.createButton(this.renderer));\n  }\n\n  loadRoom() {\n    let cb = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : () => {};\n    //载入模型\n    const loader = new GLTFLoader();\n    loader.load('/mp5/scene.gltf', gltf => {\n      // this.mixer= new AnimationMixer(gltf.scene)\n      // var action=this.mixer.clipAction(gltf.animations[0])\n      // // action.timeScale=0.8\n      // action.time=4\n      gltf.scene.traverse(object => {\n        if (object.isMesh) {\n          // 修改模型的材质\n          object.castShadow = true;\n          object.frustumCulled = false; // object.receiveShadow = true;\n\n          object.material.emissive = object.material.color;\n          object.material.emissiveMap = object.material.map;\n        }\n      });\n      gltf.scene.receiveShadow = true;\n      this.model = gltf.scene;\n      this.scene.add(gltf.scene);\n      gltf.scene.position.set(0, 0, 0);\n      gltf.scene.scale.set(0.3, 0.3, 0.3);\n      cb();\n    }, () => {}, e => {\n      console.log(\"error\", e);\n    });\n  }\n\n  addObject() {\n    for (var _len = arguments.length, object = new Array(_len), _key = 0; _key < _len; _key++) {\n      object[_key] = arguments[_key];\n    }\n\n    object.forEach(elem => {\n      this.scene.add(elem);\n    });\n  }\n\n  disableControls() {\n    this.controls.enabled = false;\n  }\n\n  enableControls() {\n    this.controls.enabled = true;\n  }\n\n}","map":{"version":3,"names":["PerspectiveCamera","Scene","Vector3","WebGLRenderer","Clock","Raycaster","UnsignedByteType","LinearToneMapping","Stats","FirstPersonControls","GLTFLoader","RGBELoader","VRButton","ambientLight","TEngine","constructor","dom","renderer","mixer","pmremGenerator","scene","raycaster","camera","clock","controls","model","heart","newEnterIndex","stats","antialias","xr","enabled","shadowMap","toneMapping","add","setDataType","load","texture","console","log","e","offsetWidth","offsetHeight","setSize","statsDom","domElement","style","position","top","right","left","lookSpeed","movementSpeed","constrainVertical","verticalMin","Math","PI","verticalMax","object","set","lookAt","up","onWindowResize","aspect","window","innerWidth","innerHeight","updateProjectionMatrix","addEventListener","setAnimationLoop","update","getDelta","render","appendChild","createButton","loadRoom","cb","loader","gltf","traverse","isMesh","castShadow","frustumCulled","material","emissive","color","emissiveMap","map","receiveShadow","scale","addObject","forEach","elem","disableControls","enableControls"],"sources":["/home/malf/code/game-demo/client/src/TEngine/TEngine.ts"],"sourcesContent":["import {\n  AmbientLight,\n  AxesHelper,\n  BoxBufferGeometry,\n  GridHelper,\n  RGBAFormat,\n  TextureLoader,\n  ObjectLoader,\n  DoubleSide,\n  Mesh,\n  MeshStandardMaterial,\n  PerspectiveCamera,\n  Scene,\n  Vector2,\n  Vector3,\n  WebGLRenderer,\n  MOUSE,\n  Object3D,\n  Group,\n  Clock,\n  Raycaster,\n  TetrahedronBufferGeometry,\n  VideoTexture,\n  PMREMGenerator,\n  UnsignedByteType,\n  HemisphereLight,\n  CanvasTexture,\n  AnimationMixer,\n  MeshBasicMaterial,\n  PlaneGeometry,\n  CineonToneMapping,\n  LinearToneMapping,\n  QuadraticBezierCurve3\n} from \"three\"\nimport Stats from 'three/examples/jsm/libs/stats.module'\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls'\nimport { FirstPersonControls } from 'three/examples/jsm/controls/FirstPersonControls'\nimport { PointerLockControls } from 'three/examples/jsm/controls/PointerLockControls'\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader'\nimport { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader';\nimport { VRButton } from 'three/examples/jsm/webxr/VRButton.js';\nimport { ambientLight } from './Tlights'\nexport class TEngine {\n\n  private dom: HTMLElement\n  public renderer: WebGLRenderer\n  private mixer: AnimationMixer | undefined\n  private pmremGenerator!: PMREMGenerator\n  private scene: Scene\n  private raycaster:Raycaster\n  private camera: PerspectiveCamera\n  private clock: Clock\n  private controls: FirstPersonControls | OrbitControls\n\n  private model!: Group\n  private heart!: Group\n  private newEnterIndex = 0\n  stats: Stats\n  constructor(dom: HTMLElement) {\n    this.dom = dom\n    this.renderer = new WebGLRenderer({\n      antialias: true\n    })\n    this.renderer.xr.enabled = true;\n    this.clock = new Clock()\n    this.renderer.shadowMap.enabled = true;\n    this.renderer.toneMapping = LinearToneMapping\n    this.scene = new Scene()\n    this.scene.add(ambientLight);\n    //const pmremGenerator = new PMREMGenerator(this.renderer); // 使用hdr作为背景色\n    //pmremGenerator.compileEquirectangularShader();\n    //this.pmremGenerator = pmremGenerator;\n    const scene = this.scene;\n    \n    new RGBELoader()\n      .setDataType(UnsignedByteType)\n      .load('/texture/autumn_forest_04_1k.hdr', function (texture) {\n        // const envMap = pmremGenerator.fromEquirectangular(texture).texture;\n        // envMap.isPmremTexture = true;\n        // pmremGenerator.dispose();\n        console.log('here');\n        // scene.environment = envMap; // 给场景添加环境光效果\n        // scene.background = envMap; // 给场景添加背景图\n      }, () => { }, (e) => { console.log('error in load env_texture', e); });\n\n    this.camera = new PerspectiveCamera(60, dom.offsetWidth / dom.offsetHeight, 1, 1000)\n\n    \n\n    this.renderer.setSize(dom.offsetWidth, dom.offsetHeight, true)\n\n    // 初始性能监视器\n    const stats = Stats()\n    const statsDom = stats.domElement\n    this.stats = stats;\n    statsDom.style.position = 'fixed'\n    statsDom.style.top = '0'\n    statsDom.style.right = '5px'\n    statsDom.style.left = 'unset'\n\n\n\n    let controls;\n   \n      controls = new FirstPersonControls(this.camera, this.dom);\n      controls.lookSpeed = 0.2; //鼠标移动查看的速度\n      controls.movementSpeed = 20; //相机移动速度\n      // controls.noFly = true;\n      controls.constrainVertical = true; //约束垂直\n      controls.verticalMin = Math.PI / 2;\n\n      controls.verticalMax = Math.PI / 2 + 0.0000001;\n  \n\n    this.controls = controls\n\n    this.controls.object.position.set(0, 28, 20)\n    this.controls.object.lookAt(new Vector3(0, 0, 0))\n\n    this.camera.up = new Vector3(0, 1, 0)\n\n   \n    const raycaster = new Raycaster();\n    this.raycaster=raycaster;\n    const onWindowResize = () => {\n\n      this.camera.aspect = window.innerWidth / window.innerHeight;\n      this.camera.updateProjectionMatrix();\n\n      this.renderer.setSize(dom.offsetWidth, dom.offsetHeight, true);\n\n    }\n    window.addEventListener('resize', onWindowResize);\n\n    //     const renderFun = () => {\n    // //@ts-ignore\n    //       this.controls.update(this.clock.getDelta())\n    //       this.renderer.render(this.scene, this.camera)\n    //       stats.update()\n    //       TWEEN.update();\n    //      updateUserVideoRotation()\n    //       requestAnimationFrame(renderFun)\n    //     }\n    //this.renderid=requestAnimationFrame(this.renderFun);\n\n    this.renderer.setAnimationLoop(() => {\n      this.controls.update(this.clock.getDelta())\n      \n      this.renderer.render(this.scene, this.camera)\n      stats.update()\n    })\n\n\n\n    dom.appendChild(this.renderer.domElement)\n    dom.appendChild(statsDom)\n    dom.appendChild(VRButton.createButton(this.renderer))\n  }\n\n  loadRoom(cb = () => { }) {\n    //载入模型\n    const loader: GLTFLoader = new GLTFLoader()\n\n    loader.load('/mp5/scene.gltf', (gltf) => {\n\n      // this.mixer= new AnimationMixer(gltf.scene)\n      // var action=this.mixer.clipAction(gltf.animations[0])\n      // // action.timeScale=0.8\n      // action.time=4\n      gltf.scene.traverse((object) => {\n        if ((object as Mesh).isMesh) {\n          // 修改模型的材质\n          object.castShadow = true;\n          object.frustumCulled = false;\n          // object.receiveShadow = true;\n\n          (object as any).material.emissive = (object as any).material.color;\n          (object as any).material.emissiveMap = (object as any).material.map;\n        }\n      })\n      gltf.scene.receiveShadow = true\n      this.model = gltf.scene\n      this.scene.add(gltf.scene)\n      gltf.scene.position.set(0, 0, 0)\n      gltf.scene.scale.set(0.3, 0.3, 0.3)\n      cb();\n    }, () => { }, (e) => { console.log(\"error\", e) })\n\n  }\n  addObject(...object: Object3D[]) {\n    object.forEach(elem => {\n      this.scene.add(elem)\n    })\n  }\n\n  disableControls() {\n    this.controls.enabled = false\n  }\n  enableControls() {\n    this.controls.enabled = true\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}